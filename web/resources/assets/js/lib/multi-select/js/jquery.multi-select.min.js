/*
* MultiSelect v0.8
* Copyright (c) 2012 Louis Cuny
*
* This program is free software. It comes without any warranty, to
* the extent permitted by applicable law. You can redistribute it
* and/or modify it under the terms of the Do What The Fuck You Want
* To Public License, Version 2, as published by Sam Hocevar. See
* http://sam.zoy.org/wtfpl/COPYING for more details.
*/

(function(a){var q={init:function(e){this.settings={disabledClass:"disabled",selectCallbackOnInit:!1,keepOrder:!1};e&&(this.settings=a.extend(this.settings,e));var d=this;d.css("position","absolute").css("left","-9999px");return d.each(function(){var c=a(this);if(0==c.next(".ms-container").length){c.attr("id",c.attr("id")?c.attr("id"):"ms-"+Math.ceil(1E3*Math.random()));var b=a('<div id="ms-'+c.attr("id")+'" class="ms-container"></div>'),e=a('<div class="ms-selectable"></div>'),f=a('<div class="ms-selection"></div>'),
h=a('<ul class="ms-list"></ul>'),m=a('<ul class="ms-list"></ul>');c.data("settings",d.settings);var k=null,g=null,j=0,n=0;c.find("optgroup,option").each(function(){if(a(this).is("optgroup"))k=a(this).attr("label"),g="ms-"+c.attr("id")+"-optgroup-"+j,h.append(a('<li class="ms-optgroup-container" id="'+g+'"><ul class="ms-optgroup"><li class="ms-optgroup-label">'+k+"</li></ul></li>")),j++;else{var b=a(this).attr("class")?" "+a(this).attr("class"):"",b=a('<li class="ms-elem-selectable'+b+'" ms-value="'+
a(this).val()+'">'+a(this).text()+"</li>");a(this).attr("title")&&b.attr("title",a(this).attr("title"));if(a(this).attr("disabled")||c.attr("disabled"))b.attr("disabled","disabled"),b.addClass(d.settings.disabledClass);b.click(function(){c.multiSelect("select",a(this).attr("ms-value"))});(g?h.children("#"+g).find("ul").first():h).append(b)}});d.settings.selectableHeader&&e.append(d.settings.selectableHeader);e.append(h);d.settings.selectedHeader&&f.append(d.settings.selectedHeader);f.append(m);b.append(e);
b.append(f);c.after(b);c.find("option:selected").each(function(){c.multiSelect("select",a(this).val(),"init")});a(".ms-elem-selectable",h).on("mouseenter",function(){a("li",b).removeClass("ms-hover");a(this).addClass("ms-hover")}).on("mouseout",function(){a("li",b).removeClass("ms-hover")});h.on("focusin",function(){a(this).addClass("ms-focus");m.focusout()}).on("focusout",function(){a(this).removeClass("ms-focus");a("li",b).removeClass("ms-hover")});m.on("focusin",function(){a(this).addClass("ms-focus")}).on("mouseleave focusout",
function(){a(this).removeClass("ms-focus");a("li",b).removeClass("ms-hover")});c.on("focusin",function(){h.focus()}).on("focusout",function(){h.removeClass("ms-focus");m.removeClass("ms-focus")});c.onKeyDown=function(e,d){var f=a("."+d+" li:visible:not(.ms-optgroup-label, .ms-optgroup-container)",b),g=f.length,j=a("."+d+" li.ms-hover",b),k=a("."+d+" li:visible:not(.ms-optgroup-label, .ms-optgroup-container)",b).index(j),l=f.first().outerHeight(),p=Math.ceil(b.outerHeight()/l),p=Math.ceil(p/4);f.removeClass("ms-hover");
if(32==e.keyCode)c.multiSelect("ms-selectable"==d?"select":"deselect",j.first().attr("ms-value"));else if(40==e.keyCode)g=k+1!=g?k+1:0,f.eq(g).addClass("ms-hover"),g>p?n+=l:0==g&&(n=0),a("."+d+" ul",b).scrollTop(n);else if(38==e.keyCode)j=0<=k-1?k-1:g-1,k=f.eq(j),f.removeClass("ms-hover"),k.addClass("ms-hover"),n=g-j+1<p?l*(g-p):n-l,a("."+d+" ul",b).scrollTop(n);else if(37==e.keyCode||39==e.keyCode)h.hasClass("ms-focus")?(h.focusout(),m.focusin()):(h.focusin(),m.focusout())};c.on("keydown",function(a){if(c.is(":focus")){var b=
h.hasClass("ms-focus")?"ms-selectable":"ms-selection";c.onKeyDown(a,b)}})}})},refresh:function(){a("#ms-"+a(this).attr("id")).remove();a(this).multiSelect("init",a(this).data("settings"))},select:function(e,d){var c=this,b=c.find('option[value="'+e+'"]'),l=b.text(),f=b.attr("class"),h=b.attr("title"),f=a('<li class="ms-elem-selected'+(f?" "+f:"")+'" ms-value="'+e+'">'+l+"</li>"),m=a("#ms-"+c.attr("id")+" .ms-selectable ul"),k=a("#ms-"+c.attr("id")+" .ms-selection ul"),g=m.children('li[ms-value="'+
e+'"]'),j=null;"init"==d?j=!g.hasClass(c.data("settings").disabledClass)&&b.prop("selected"):(j=!g.hasClass(c.data("settings").disabledClass),c.focus());if(j&&0==k.children('li[ms-value="'+e+'"]').length){j=g.parent(".ms-optgroup");0<j.length&&1==j.children(".ms-elem-selectable:not(:hidden)").length&&j.children(".ms-optgroup-label").hide();g.addClass("ms-selected");g.hide();b.prop("selected",!0);h&&f.attr("title",h);g.hasClass(c.data("settings").disabledClass)?f.addClass(c.data("settings").disabledClass):
f.click(function(){c.multiSelect("deselect",a(this).attr("ms-value"))});b=k.children(".ms-elem-selected");if("init"!=d&&c.data("settings").keepOrder&&0<b.length)if(h=function(a){elems=m.children(".ms-elem-selectable");return elems.index(elems.closest('[ms-value="'+a+'"]'))},g=h(f.attr("ms-value")),0==g)k.prepend(f);else for(i=g-1;0<=i;i--)if(b[i]&&h(a(b[i]).attr("ms-value"))<g){a(b[i]).after(f);break}else 0==i&&a(b[i]).before(f);else k.append(f);f.on("mouseenter",function(){a("li",k).removeClass("ms-hover");
a(this).addClass("ms-hover")}).on("mouseout",function(){a("li",k).removeClass("ms-hover")});"select_all"==d&&0<j.children(".ms-elem-selectable").length&&j.children(".ms-optgroup-label").hide();if("init"!=d||c.data("settings").selectCallbackOnInit)c.trigger("change"),k.trigger("change"),m.trigger("change"),"function"==typeof c.data("settings").afterSelect&&("init"!=d||c.data("settings").selectCallbackOnInit)&&c.data("settings").afterSelect.call(this,e,l)}},deselect:function(e){var d=a("#ms-"+this.attr("id")+
" .ms-selection ul"),c=this.find('option[value="'+e+'"]'),b=d.children('li[ms-value="'+e+'"]');if(b){d.focusin();var l=a("#ms-"+this.attr("id")+" .ms-selectable ul"),d=a("#ms-"+this.attr("id")+" .ms-selection ul"),f=l.children('li[ms-value="'+e+'"]'),b=d.children('li[ms-value="'+e+'"]'),h=f.parent(".ms-optgroup");0<h.length&&(h.children(".ms-optgroup-label").addClass("ms-collapse").show(),h.children(".ms-elem-selectable:not(.ms-selected)").show());c.prop("selected",!1);f.show();f.removeClass("ms-selected");
b.remove();d.trigger("change");l.trigger("change");this.trigger("change");"function"==typeof this.data("settings").afterDeselect&&this.data("settings").afterDeselect.call(this,e,b.text())}},select_all:function(e){var d=this,c=a("#ms-"+d.attr("id")+" .ms-selectable ul");d.find("option:not(:selected)").each(function(){var b=a(this).val();e?0<c.children('li[ms-value="'+b+'"]').filter(":visible").length&&d.multiSelect("select",b,"select_all"):d.multiSelect("select",b,"select_all")})},deselect_all:function(){var e=
this;a("#ms-"+e.attr("id")+" .ms-selection ul");e.find("option:selected").each(function(){e.multiSelect("deselect",a(this).val(),"deselect_all")})}};a.fn.multiSelect=function(a){if(q[a])return q[a].apply(this,Array.prototype.slice.call(arguments,1));if("object"===typeof a||!a)return q.init.apply(this,arguments);console.log&&console.log("Method "+a+" does not exist on jquery.multiSelect");return!1}})(jQuery);